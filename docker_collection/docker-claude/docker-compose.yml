version: '3.8'

services:
  claude-code:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        TZ: ${TZ:-Asia/Shanghai}
        CLAUDE_CODE_VERSION: ${CLAUDE_CODE_VERSION:-latest}
    container_name: claude-code-container
    hostname: claude-code

    # 无头模式配置
    stdin_open: true
    tty: true

    # 环境变量
    environment:
      - NODE_OPTIONS=--max-old-space-size=4096
      - CLAUDE_CONFIG_DIR=/home/node/.claude
      - POWERLEVEL9K_DISABLE_GITSTATUS=true
      - DEVCONTAINER=true
      - TZ=${TZ:-Asia/Shanghai}
      - CLAUDE_CODE_VERSION=${CLAUDE_CODE_VERSION:-latest}

    # 挂载配置
    volumes:
      # 挂载当前工作目录到容器的 /workspace
      - .:/workspace:rw

      # 直接挂载主机的 ~/.claude 目录，实现双向同步
      - ${HOME}/.claude:/home/node/.claude:rw

      # 挂载 bash 历史记录
      - claude-bash-history:/commandhistory

      # 挂载 SSH 目录
      - ${HOME}/.ssh:/home/node/.ssh:rw

    # 启动命令 - 预置 --dangerously-skip-permissions 参数
    command: >
      bash -c "
        # 为claude命令创建别名，自动添加 --dangerously-skip-permissions
        echo 'alias claude=\"claude --dangerously-skip-permissions\"' >> /home/node/.zshrc &&
        # 启动 zsh shell
        exec zsh
      "

    # 健康检查 - 使用简单的进程检查
    healthcheck:
      test: ["CMD-SHELL", "exit 0"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 10s

    # 重启策略
    restart: unless-stopped

    # 资源限制
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '4.0'
    #       memory: 8G
    #     reservations:
    #       cpus: '1.0'
    #       memory: 2G

# 命名卷定义
volumes:
  claude-bash-history:
    driver: local
