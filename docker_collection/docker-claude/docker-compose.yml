services:
  claude-code:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        TZ: ${TZ:-Asia/Shanghai}
        CLAUDE_CODE_VERSION: ${CLAUDE_CODE_VERSION:-latest}
    image: claude-code-local:latest
    pull_policy: never
    hostname: claude-code

    # 无头模式配置
    stdin_open: true
    tty: true

    # 权限配置 - 防火墙脚本需要
    cap_add:
      - NET_ADMIN
      - NET_RAW

    # 环境变量
    env_file:
      - .env
    environment:
      - NODE_OPTIONS=--max-old-space-size=4096
      - CLAUDE_CONFIG_DIR=/home/node/.claude
      - POWERLEVEL9K_DISABLE_GITSTATUS=true
      - DEVCONTAINER=true
      - TZ=${TZ:-Asia/Shanghai}
      - CLAUDE_CODE_VERSION=${CLAUDE_CODE_VERSION:-latest}

    # 挂载配置 - 启动时由 entrypoint 复制到容器内
    volumes:
      - .:/workspace:rw
      - claude-bash-history:/commandhistory
      - ${HOME}/.claude:/host-claude:ro
      - ${HOME}/.agents:/host-agents:ro
      - ${HOME}/.ssh:/host-ssh:ro

    # 启动命令 - 已在 Dockerfile 的 entrypoint 中处理

    # 健康检查
    healthcheck:
      test: ["CMD-SHELL", "exit 0"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 10s

# 命名卷定义
volumes:
  claude-bash-history:
    driver: local
